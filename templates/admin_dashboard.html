{% extends "base.html" %}
{% block content %}
<section class="section">
  <div class="container">
    <h1>Admin-Dashboard</h1>

    <!-- Kennzahlen -->
    <div class="features" style="margin-bottom:1rem">
      <article class="feature">
        <h3>Gesamt</h3>
        <p><strong>{{ total }}</strong> Antworten</p>
      </article>
      <article class="feature">
        <h3>Zusagen</h3>
        <p><strong>{{ yes_count }}</strong> Personen · <span class="muted">{{ guests_yes }} Gäste gesamt</span></p>
      </article>
      <article class="feature">
        <h3>Absagen</h3>
        <p><strong>{{ no_count }}</strong></p>
      </article>
      <article class="feature">
        <h3>Verteilung (Zusage)</h3>
        <p>Fr: {{ fri_count }} · Sa: {{ sat_count }} · Beide: {{ both_count }}</p>
      </article>
    </div>

    <!-- Filter / Suche / Sortierung -->
    <form method="get" action="{{ url_for('admin_dashboard') }}" class="card" style="padding: .75rem; margin-bottom:1rem; display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:.5rem">
      <label>
        <span>Status</span>
        <select name="attendance">
          <option value="" {{ 'selected' if not attendance }}>Alle</option>
          <option value="yes" {{ 'selected' if attendance=='yes' }}>Zusage</option>
          <option value="no"  {{ 'selected' if attendance=='no'  }}>Absage</option>
        </select>
      </label>

      <label>
        <span>Tage</span>
        <select name="days">
          <option value="" {{ 'selected' if not days }}>Alle</option>
          <option value="fri"  {{ 'selected' if days=='fri'  }}>Freitag</option>
          <option value="sat"  {{ 'selected' if days=='sat'  }}>Samstag</option>
          <option value="both" {{ 'selected' if days=='both' }}>Beide</option>
        </select>
      </label>

      <label>
        <span>Sortierung</span>
        <select name="order">
          <option value="created_desc" {{ 'selected' if order=='created_desc' }}>Neueste zuerst</option>
          <option value="created_asc"  {{ 'selected' if order=='created_asc'  }}>Älteste zuerst</option>
          <option value="name_asc"     {{ 'selected' if order=='name_asc'     }}>Name A→Z</option>
          <option value="name_desc"    {{ 'selected' if order=='name_desc'    }}>Name Z→A</option>
        </select>
      </label>

      <label>
        <span>Treffer / Seite</span>
        <select name="per_page">
          {% for n in [25,50,100,200] %}
            <option value="{{ n }}" {{ 'selected' if per_page==n }}>{{ n }}</option>
          {% endfor %}
        </select>
      </label>

      <label class="grid--span-2">
        <span>Suche (Name, E-Mail, Notizen, Spende)</span>
        <input type="text" name="q" value="{{ q or '' }}" placeholder="z. B. Nachname, Allergie, Gericht …">
      </label>

      <div style="display:flex; align-items:end; gap:.5rem">
        <button class="btn" type="submit">Anwenden</button>
        <a class="btn btn--ghost" href="{{ url_for('admin_dashboard') }}">Zurücksetzen</a>
        <a class="btn btn--ghost" href="{{ url_for('export_csv') }}">CSV-Export</a>
      </div>
    </form>

    <!-- Liste + Inline-Edit -->
    <div class="card" style="overflow:auto">
      <table style="width:100%; border-collapse:collapse">
        <thead>
          <tr>
            <th style="text-align:left; padding:.5rem; border-bottom:1px solid var(--border)">Datum</th>
            <th style="text-align:left; padding:.5rem; border-bottom:1px solid var(--border)">Name</th>
            <th style="text-align:left; padding:.5rem; border-bottom:1px solid var(--border)">E-Mail</th>
            <th style="text-align:left; padding:.5rem; border-bottom:1px solid var(--border)">Status</th>
            <th style="text-align:left; padding:.5rem; border-bottom:1px solid var(--border)">Tage</th>
            <th style="text-align:left; padding:.5rem; border-bottom:1px solid var(--border)">Spende</th>
            <th style="text-align:right; padding:.5rem; border-bottom:1px solid var(--border)">Personen</th>
            <th style="text-align:left; padding:.5rem; border-bottom:1px solid var(--border)">Notizen</th>
            <th style="padding:.5rem; border-bottom:1px solid var(--border)">Aktionen</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rsvps %}
          <tr>
            <td style="padding:.5rem; border-bottom:1px solid var(--border)">{{ r.created_at.strftime("%d.%m.%Y %H:%M") }}</td>
            <td style="padding:.5rem; border-bottom:1px solid var(--border)">{{ r.name }}</td>
            <td style="padding:.5rem; border-bottom:1px solid var(--border)">{{ r.email }}</td>

            <td style="padding:.5rem; border-bottom:1px solid var(--border)">
              <form action="{{ url_for('admin_rsvps_update') }}" method="post" style="display:flex; gap:.4rem; align-items:center; flex-wrap:wrap">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="id" value="{{ r.id }}">
                <select name="attendance">
                  <option value="yes" {{ 'selected' if r.attendance=='yes' else '' }}>Zusage</option>
                  <option value="no"  {{ 'selected' if r.attendance=='no'  else '' }}>Absage</option>
                </select>
            </td>

            <td style="padding:.5rem; border-bottom:1px solid var(--border)">
              <select name="attendance_days">
                <option value=""    {{ 'selected' if not r.attendance_days }}>–</option>
                <option value="fri"  {{ 'selected' if r.attendance_days=='fri'  }}>Freitag</option>
                <option value="sat"  {{ 'selected' if r.attendance_days=='sat'  }}>Samstag</option>
                <option value="both" {{ 'selected' if r.attendance_days=='both' }}>Beide</option>
              </select>
            </td>

            <td style="padding:.5rem; border-bottom:1px solid var(--border)">
              <input type="text" name="contribution" value="{{ r.contribution or '' }}" placeholder="optional" style="width:100%">
            </td>

            <td style="padding:.5rem; border-bottom:1px solid var(--border); text-align:right">
              <input type="number" name="guests" min="1" max="10" value="{{ r.guests or 1 }}" style="width:64px; text-align:right">
            </td>

            <td style="padding:.5rem; border-bottom:1px solid var(--border)">
              <input type="text" name="notes" value="{{ r.notes or '' }}" style="width:100%">
            </td>

            <td style="padding:.5rem; border-bottom:1px solid var(--border); white-space:nowrap">
              <button class="btn btn--small" type="submit">Speichern</button>
              </form>
              <form action="{{ url_for('admin_rsvps_delete') }}" method="post" style="display:inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="id" value="{{ r.id }}">
                <button class="btn btn--small btn--ghost" type="submit" onclick="return confirm('Wirklich löschen?')">Löschen</button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="9" style="padding:.75rem">Keine Einträge gefunden.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if pages > 1 %}
    <nav style="margin-top:1rem; display:flex; gap:.5rem; flex-wrap:wrap">
      {% for p in range(1, pages+1) %}
        <a class="btn btn--small {{ 'btn--ghost' if p != page }}"
           href="{{ url_for('admin_dashboard', page=p, attendance=attendance, days=days, q=q, order=order, per_page=per_page) }}">{{ p }}</a>
      {% endfor %}
    </nav>
    {% endif %}
  </div>
</section>
{% endblock %}
